<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>í•œêµ­ì–´â†’ì¼ë³¸ì–´ ìë™ ë²ˆì—­ + ë…ìŒ ë¶„ì„ê¸°</title>
    <style>
:root {
    --highlight-color-start: #ffd54f;
    --highlight-color-end: #ffb300;
    --highlight-shadow: rgba(255, 179, 0, 0.3);
}

body {
    font-family: system-ui, -apple-system, "Noto Sans JP", "Noto Sans KR", Arial;
    padding: 18px;
    background: #f6f8fb;
    color: #111;
}

.panel {
    max-width: 980px;
    margin: 0 auto 20px;
    background: #fff;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
}

h2 {
    margin-top: 0;
    color: #2b7cff;
}

label {
    display: block;
    margin-top: 12px;
    font-weight: 600;
    color: #333;
}

textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 15px;
    font-family: inherit;
}

.controls {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 14px;
    flex-wrap: wrap;
}

button {
    padding: 10px 16px;
    border-radius: 8px;
    border: 0;
    background: #2b7cff;
    color: #fff;
    cursor: pointer;
    font-weight: 600;
    transition: background .2s;
}

button:hover {
    background: #1a5fd9;
}

button:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.btn-secondary {
    background: #666;
}

.btn-secondary:hover {
    background: #555;
}

.preview {
    margin-top: 20px;
    min-height: 160px;
    padding: 24px;
    border-radius: 12px;
    background: #0b1220;
    color: #fff;
    font-size: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    line-height: 1.6;
}

.word {
    display: inline-block;
    margin: 0 8px 8px 0;
    opacity: 0.08;
    transition: opacity .3s, transform .3s;
    transform: translateY(8px);
    white-space: nowrap;
}

.word.revealed {
    opacity: 1;
    transform: none;
}

ruby {
    font-size: 1em;
    line-height: 1;
}

rt {
    font-size: 0.36em;
    display: block;
    line-height: 1.2;
    margin-bottom: 6px;
    color: #ffd;
    font-weight: 400;
}

.hint {
    font-size: 13px;
    color: #666;
    margin-top: 10px;
    line-height: 1.5;
}

.status {
    font-size: 14px;
    color: #2b7cff;
    margin-top: 12px;
    font-weight: 500;
}

.small {
    font-size: 12px;
    color: #999;
    margin-top: 10px;
}

.danger {
    color: #d32f2f;
}

.translation-box {
    margin-top: 20px;
    padding: 16px;
    background: #f0f9ff;
    border-radius: 8px;
    border-left: 4px solid #0ea5e9;
}

.translation-label {
    font-weight: 700;
    color: #0369a1;
    margin-bottom: 8px;
    font-size: 14px;
}

.translation-text {
    font-size: 18px;
    font-weight: 600;
    color: #1a237e;
    font-family: 'Noto Sans JP', sans-serif;
    line-height: 1.6;
}

.cumulative-section {
    margin-top: 24px;
    padding: 20px;
    background: #fff9f0;
    border-radius: 10px;
    border: 1px solid #ffe0b2;
}

.cumulative-section h3 {
    margin: 0 0 16px 0;
    color: #e65100;
    font-size: 17px;
    font-weight: 700;
}

.cumulative-item {
    padding: 16px;
    margin-bottom: 16px;
    background: #fff;
    border-radius: 8px;
    border-left: 4px solid #ff9800;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
    opacity: 0;
    animation: fadeIn 0.4s forwards;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.cumulative-jp {
    font-size: 18px;
    font-weight: 600;
    color: #1a237e;
    margin-bottom: 6px;
    font-family: 'Noto Sans JP', sans-serif;
    line-height: 1.5;
}

.cumulative-detail {
    display: flex;
    flex-direction: column;
    margin-bottom: 4px;
    font-size: 14px;
    line-height: 1.6;
}

.new-word {
    background: linear-gradient(120deg, var(--highlight-color-start) 0%, var(--highlight-color-end) 100%);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 700;
    color: #1a237e;
    box-shadow: 0 2px 4px var(--highlight-shadow);
    animation: highlight 0.6s ease-in-out;
}

@keyframes highlight {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.result-summary-section {
    margin-top: 24px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.result-summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.result-summary-header h3 {
    margin: 0;
    color: #fff;
    font-size: 18px;
    font-weight: 700;
}

.result-summary-content {
    background: rgba(255, 255, 255, 0.95);
    padding: 20px;
    border-radius: 8px;
}

.final-result {
    margin-bottom: 16px;
}

.final-result-label {
    font-weight: 700;
    color: #667eea;
    margin-bottom: 8px;
    font-size: 14px;
}

.final-result-text {
    font-size: 20px;
    font-weight: 600;
    color: #1a237e;
    font-family: 'Noto Sans JP', sans-serif;
    line-height: 1.6;
    margin-bottom: 8px;
}

.sentence-list-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    padding: 4px;
}

.sentence-item {
    padding: 12px 16px;
    background: #fff;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid #e0e0e0;
    font-size: 15px;
    color: #333;
    line-height: 1.5;
}

.sentence-item:hover {
    background: #f0f9ff;
    border-color: #10b981;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(16, 185, 129, 0.2);
}

.sentence-item.selected {
    background: #10b981;
    color: #fff;
    border-color: #10b981;
    font-weight: 600;
}

input[type="file"] {
    padding: 10px;
    border: 2px dashed #10b981;
    border-radius: 8px;
    background: #f0fdf4;
    cursor: pointer;
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 8px;
}
    </style>
</head>
<body>
    <div class="panel" id="sentencePanel" style="display:none;">
        <h2 style="color: #10b981;">ğŸ“‹ ë¬¸ì¥ ëª©ë¡</h2>
        <div class="hint" style="margin-bottom: 12px;">ë¬¸ì¥ì„ í´ë¦­í•˜ë©´ ì•„ë˜ ì…ë ¥ì°½ì— ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.</div>
        <div class="sentence-list-container" id="sentenceList"></div>
    </div>

    <div class="panel">
        <h2>ğŸ‡°ğŸ‡·â†’ğŸ‡¯ğŸ‡µ í•œêµ­ì–´â†’ì¼ë³¸ì–´ ìë™ ë²ˆì—­ + ë…ìŒ ë¶„ì„ê¸°</h2>
        <div class="hint">í•œêµ­ì–´ ë¬¸ì¥ì„ ì…ë ¥í•˜ê³  "ì¼ë³¸ì–´ë¡œ ë²ˆì—­"ì„ ëˆ„ë¥´ë©´ ìë™ìœ¼ë¡œ ì¼ë³¸ì–´ë¡œ ë²ˆì—­ë˜ê³ , í˜•íƒœì†Œë³„ë¡œ íˆë¼ê°€ë‚˜ ì½ê¸°ì™€ í•œêµ­ì–´ ë°œìŒì„ ìƒì„±í•©ë‹ˆë‹¤.</div>

        <label>ğŸ“ í•œêµ­ì–´ ìë§‰ íŒŒì¼ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)</label>
        <input type="file" id="fileInput" accept=".srt,.txt">
        <div class="hint" style="margin-top: 8px;">SRT ë˜ëŠ” TXT íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìœ„ì— ë¬¸ì¥ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>

        <label>í•œêµ­ì–´ ë¬¸ì¥ ì…ë ¥</label>
        <textarea id="korean" rows="3" placeholder="ì˜ˆ: ì˜¤ëŠ˜ ì €ë…ì€ ë¬´ì—‡ì„ ë¨¹ì„ê¹Œ?">ì˜¤ëŠ˜ ì €ë…ì€ ë¬´ì—‡ì„ ë¨¹ì„ê¹Œ?</textarea>

        <div class="controls">
            <button id="translateBtn">ğŸ”„ ì¼ë³¸ì–´ë¡œ ë²ˆì—­</button>
            <button id="clear" class="btn-secondary">ğŸ”„ ì´ˆê¸°í™”</button>
        </div>

        <div class="status" id="status">ìƒíƒœ: ì¤€ë¹„ë¨</div>

        <div id="translationBox" style="display:none" class="translation-box">
            <div class="translation-label">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ ë²ˆì—­</div>
            <div class="translation-text" id="translatedText"></div>
        </div>

        <div class="preview" id="preview" aria-live="polite"></div>

        <div class="small">ğŸ’¡ ì¶œë ¥ í˜•ì‹: <ruby>æ—¥æœ¬èª<rt>ã²ã‚‰ãŒãªï½œí•œê¸€</rt></ruby></div>

        <div class="result-summary-section" id="resultSummarySection" style="display:none">
            <div class="result-summary-header">
                <h3>âœ¨ ì™„ì„±ëœ ë¬¸ì¥ ê²°ê³¼</h3>
            </div>
            <div class="result-summary-content">
                <div class="final-result">
                    <div class="final-result-label">ğŸ‡°ğŸ‡· í•œêµ­ì–´ ì›ë¬¸</div>
                    <div class="final-result-text" id="finalKorean"></div>
                </div>
                <div class="final-result">
                    <div class="final-result-label">ğŸ‡°ğŸ‡· í•œêµ­ì–´ ë°œìŒ</div>
                    <div class="final-result-text" id="finalKr" style="font-size: 16px; color: #d32f2f;"></div>
                </div>
                <div class="final-result">
                    <div class="final-result-label">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ ë²ˆì—­</div>
                    <div class="final-result-text" id="finalJp"></div>
                </div>
                <div class="final-result">
                    <div class="final-result-label">ğŸ”¤ íˆë¼ê°€ë‚˜ ì½ê¸°</div>
                    <div class="final-result-text" id="finalRead" style="font-size: 16px; color: #5e35b1;"></div>
                </div>
            </div>
        </div>

        <div class="cumulative-section" id="cumulativeSection" style="display:none">
            <h3>ğŸ“ ë‹¨ì–´ë³„ ë¶„ì„</h3>
            <div id="cumulativeList"></div>
        </div>
    </div>

    <script>
const API_BASE_URL = 'https://fur-qar7.onrender.com';

let wordSpans = [];
let apiResultData = [];
let sentences = [];
let selectedSentenceIndex = -1;

const statusEl = document.getElementById('status');
const koreanEl = document.getElementById('korean');
const preview = document.getElementById('preview');
const translateBtn = document.getElementById('translateBtn');
const clearBtn = document.getElementById('clear');
const cumulativeSection = document.getElementById('cumulativeSection');
const cumulativeList = document.getElementById('cumulativeList');
const resultSummarySection = document.getElementById('resultSummarySection');
const fileInput = document.getElementById('fileInput');
const sentenceList = document.getElementById('sentenceList');
const sentencePanel = document.getElementById('sentencePanel');
const translationBox = document.getElementById('translationBox');
const translatedText = document.getElementById('translatedText');

translateBtn.addEventListener('click', handleTranslate);
clearBtn.addEventListener('click', handleClear);
fileInput.addEventListener('change', handleFileUpload);

async function handleTranslate() {
    const koreanText = koreanEl.value.trim();
    if (!koreanText) {
        statusEl.textContent = 'ìƒíƒœ: í•œêµ­ì–´ ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”.';
        return;
    }

    statusEl.textContent = 'ìƒíƒœ: í•œêµ­ì–´â†’ì¼ë³¸ì–´ ë²ˆì—­ ì¤‘... â³';
    translateBtn.disabled = true;

    try {
        const resp = await fetch(`${API_BASE_URL}/api/translate-kr-to-jp`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: koreanText })
        });

        const responseText = await resp.text();

        if (!resp.ok) {
            let errorMessage = `${resp.status} ${resp.statusText}`;
            try {
                const error = JSON.parse(responseText);
                errorMessage = error.error || errorMessage;
            } catch (e) {
                errorMessage = `ì„œë²„ ì˜¤ë¥˜ (${resp.status})`;
            }
            throw new Error(errorMessage);
        }

        const data = JSON.parse(responseText);
        
        translatedText.textContent = data.translatedText;
        translationBox.style.display = 'block';
        
        buildFromApiResult(data.analysis, koreanText, data.translatedText);
        statusEl.textContent = 'ìƒíƒœ: ë²ˆì—­ ë° ë¶„ì„ ì™„ë£Œ! âœ“';
    } catch (err) {
        console.error(err);
        statusEl.textContent = 'ìƒíƒœ: ë²ˆì—­ ì‹¤íŒ¨ âœ–';
        statusEl.className = 'status danger';
        alert('ë²ˆì—­ API í˜¸ì¶œ ì‹¤íŒ¨:\n' + (err.message || err));
    } finally {
        translateBtn.disabled = false;
        statusEl.className = 'status';
    }
}

function buildFromApiResult(arr, koreanOriginal, japaneseTranslation) {
    clearPreview();

    if (!Array.isArray(arr) || arr.length === 0) {
        statusEl.textContent = 'ìƒíƒœ: ë³€í™˜ ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.';
        preview.innerHTML = '<div style="opacity:0.5;font-size:18px;">ê²°ê³¼ ì—†ìŒ</div>';
        return;
    }

    apiResultData = arr;

    arr.forEach((seg, idx) => {
        const sp = document.createElement('span');
        sp.className = 'word revealed';
        sp.dataset.index = idx;

        const rb = document.createElement('ruby');
        rb.textContent = seg.jp;

        const rt = document.createElement('rt');
        const read = seg.read || '';
        const kr = seg.kr || '';
        rt.textContent = read + (read && kr ? 'ï½œ' : '') + kr;

        if (rt.textContent) rb.appendChild(rt);
        sp.appendChild(rb);
        preview.appendChild(sp);
        wordSpans.push(sp);
    });

    buildCumulativeResults(arr);
    updateFinalResult(arr, koreanOriginal, japaneseTranslation);
}

function buildCumulativeResults(arr) {
    cumulativeList.innerHTML = '';

    arr.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'cumulative-item';
        div.style.animationDelay = `${idx * 0.1}s`;

        // 1. Meaning (ëœ»)
        const meaningDiv = document.createElement('div');
        meaningDiv.className = 'cumulative-detail';
        meaningDiv.innerHTML = `
            <div style="margin-bottom: 4px;">
                <span style="color: #0277bd; font-weight: 500;">ëœ»: ${item.meaning || ''}</span>
            </div>
        `;
        div.appendChild(meaningDiv);

        // 2. Pronunciation (ë°œìŒ)
        const pronDiv = document.createElement('div');
        pronDiv.className = 'cumulative-detail';
        pronDiv.innerHTML = `
            <div style="margin-bottom: 6px;">
                <span style="color: #d32f2f; font-weight: 600;">ë°œìŒ: ${item.kr || ''}</span>
            </div>
        `;
        div.appendChild(pronDiv);

        // 3. Japanese Word (ì¼ë³¸ì–´ ë‹¨ì–´)
        const jpText = document.createElement('div');
        jpText.className = 'cumulative-jp';
        jpText.innerHTML = `<span class="new-word">${item.jp}</span>`;
        div.appendChild(jpText);

        // 4. Hiragana (íˆë¼ê°€ë‚˜)
        const hiraganaDiv = document.createElement('div');
        hiraganaDiv.className = 'cumulative-detail';
        hiraganaDiv.innerHTML = `
            <div>
                <span style="color: #5e35b1; font-weight: 600;">íˆë¼ê°€ë‚˜: ${item.read || ''}</span>
            </div>
        `;
        div.appendChild(hiraganaDiv);

        cumulativeList.appendChild(div);
    });

    cumulativeSection.style.display = 'block';
}

function updateFinalResult(arr, koreanOriginal, japaneseTranslation) {
    if (!arr || arr.length === 0) return;

    document.getElementById('finalKorean').textContent = koreanOriginal;
    
    const pronunciations = arr.map(item => item.kr).join(' ');
    document.getElementById('finalKr').textContent = pronunciations;
    
    document.getElementById('finalJp').textContent = japaneseTranslation;

    const readingsWithSlash = arr.map(item => item.read).join('/');
    document.getElementById('finalRead').textContent = readingsWithSlash;

    resultSummarySection.style.display = 'block';
}

function clearPreview() {
    preview.innerHTML = '';
    wordSpans = [];
    cumulativeSection.style.display = 'none';
    cumulativeList.innerHTML = '';
    resultSummarySection.style.display = 'none';
    translationBox.style.display = 'none';
    apiResultData = [];
}

function handleClear() {
    koreanEl.value = '';
    clearPreview();
    statusEl.textContent = 'ìƒíƒœ: ì´ˆê¸°í™”ë¨';
}

function parseSrtFile(text) {
    const lines = text.split(/\r?\n|\r/);
    const sentences = [];
    let currentText = '';

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();

        if (!line || /^\d+$/.test(line) || /\d{2}:\d{2}:\d{2}/.test(line)) {
            if (currentText && /[ê°€-í£]/.test(currentText)) {
                sentences.push(currentText.trim());
                currentText = '';
            }
            continue;
        }

        if (/[ê°€-í£]/.test(line)) {
            if (currentText) {
                currentText += ' ' + line;
            } else {
                currentText = line;
            }
        }
    }

    if (currentText && /[ê°€-í£]/.test(currentText)) {
        sentences.push(currentText.trim());
    }

    return sentences;
}

async function handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
        const text = await file.text();

        if (file.name.endsWith('.srt')) {
            sentences = parseSrtFile(text);
        } else {
            sentences = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .filter(line => /[ê°€-í£]/.test(line));
        }

        if (sentences.length === 0) {
            alert('íŒŒì¼ì—ì„œ í•œêµ­ì–´ ë¬¸ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        displaySentenceList();
        statusEl.textContent = `ìƒíƒœ: ${sentences.length}ê°œì˜ ë¬¸ì¥ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`;

    } catch (error) {
        console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
        alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function displaySentenceList() {
    sentenceList.innerHTML = '';

    sentences.forEach((sentence, index) => {
        const div = document.createElement('div');
        div.className = 'sentence-item';
        div.textContent = `${index + 1}. ${sentence}`;
        div.dataset.index = index;

        div.addEventListener('click', () => {
            selectSentence(index);
        });

        sentenceList.appendChild(div);
    });

    sentencePanel.style.display = 'block';
    sentencePanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function selectSentence(index) {
    selectedSentenceIndex = index;
    koreanEl.value = sentences[index];

    document.querySelectorAll('.sentence-item').forEach((item, i) => {
        if (i === index) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });

    clearPreview();
    statusEl.textContent = `ìƒíƒœ: ë¬¸ì¥ #${index + 1} ì„ íƒë¨`;

    koreanEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    koreanEl.focus();
}
    </script>
</body>
</html>
